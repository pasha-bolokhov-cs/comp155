<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- saved from url=(0087)https://online.camosun.ca/content/enforced/83589-2015Q2COMP155X01AB/Lab15.html?ou=83589 -->
<html xmlns="http://&lt;/span&gt;w.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<script type="text/javascript" src="./assign15_files/9efc9e456b"></script><script type="text/javascript">window.NREUM||(NREUM={});NREUM.info = {"beacon":"beacon-6.newrelic.com","errorBeacon":"bam.nr-data.net","licenseKey":"9efc9e456b","applicationID":"2089117","transactionName":"b1wHYUNYWxEFUkJbDlYWLUFFSX0DClVaVxMXfVd5H3VlTDBeWV4SFnERQUF0WgYRXVMcIldXEVBfTX0WCV1wWw1MXBd9UFdRDgFD","queueTime":0,"applicationTime":66,"ttGuid":"30D0959E58096DA7","agent":"js-agent.newrelic.com/nr-536.min.js"}</script><script type="text/javascript">window.NREUM||(NREUM={}),__nr_require=function(n,e,t){function r(t){if(!e[t]){var o=e[t]={exports:{}};n[t][0].call(o.exports,function(e){var o=n[t][1][e];return r(o?o:e)},o,o.exports)}return e[t].exports}if("function"==typeof __nr_require)return __nr_require;for(var o=0;o<t.length;o++)r(t[o]);return r}({QJf3ax:[function(n,e){function t(n){function e(e,t,a){n&&n(e,t,a),a||(a={});for(var u=c(e),f=u.length,s=i(a,o,r),p=0;f>p;p++)u[p].apply(s,t);return s}function a(n,e){f[n]=c(n).concat(e)}function c(n){return f[n]||[]}function u(){return t(e)}var f={};return{on:a,emit:e,create:u,listeners:c,_events:f}}function r(){return{}}var o="nr@context",i=n("gos");e.exports=t()},{gos:"7eSDFh"}],ee:[function(n,e){e.exports=n("QJf3ax")},{}],3:[function(n,e){function t(n){return function(){r(n,[(new Date).getTime()].concat(i(arguments)))}}var r=n("handle"),o=n(1),i=n(2);"undefined"==typeof window.newrelic&&(newrelic=window.NREUM);var a=["setPageViewName","trackUserAction","finished","traceEvent","inlineHit","noticeError"];o(a,function(n,e){window.NREUM[e]=t("api-"+e)}),e.exports=window.NREUM},{1:12,2:13,handle:"D5DuLP"}],gos:[function(n,e){e.exports=n("7eSDFh")},{}],"7eSDFh":[function(n,e){function t(n,e,t){if(r.call(n,e))return n[e];var o=t();if(Object.defineProperty&&Object.keys)try{return Object.defineProperty(n,e,{value:o,writable:!0,enumerable:!1}),o}catch(i){}return n[e]=o,o}var r=Object.prototype.hasOwnProperty;e.exports=t},{}],D5DuLP:[function(n,e){function t(n,e,t){return r.listeners(n).length?r.emit(n,e,t):(o[n]||(o[n]=[]),void o[n].push(e))}var r=n("ee").create(),o={};e.exports=t,t.ee=r,r.q=o},{ee:"QJf3ax"}],handle:[function(n,e){e.exports=n("D5DuLP")},{}],XL7HBI:[function(n,e){function t(n){var e=typeof n;return!n||"object"!==e&&"function"!==e?-1:n===window?0:i(n,o,function(){return r++})}var r=1,o="nr@id",i=n("gos");e.exports=t},{gos:"7eSDFh"}],id:[function(n,e){e.exports=n("XL7HBI")},{}],G9z0Bl:[function(n,e){function t(){var n=v.info=NREUM.info;if(n&&n.licenseKey&&n.applicationID&&f&&f.body){c(d,function(e,t){e in n||(n[e]=t)}),v.proto="https"===l.split(":")[0]||n.sslForHttp?"https://":"http://",a("mark",["onload",i()]);var e=f.createElement("script");e.src=v.proto+n.agent,f.body.appendChild(e)}}function r(){"complete"===f.readyState&&o()}function o(){a("mark",["domContent",i()])}function i(){return(new Date).getTime()}var a=n("handle"),c=n(1),u=(n(2),window),f=u.document,s="addEventListener",p="attachEvent",l=(""+location).split("?")[0],d={beacon:"bam.nr-data.net",errorBeacon:"bam.nr-data.net",agent:"js-agent.newrelic.com/nr-536.min.js"},v=e.exports={offset:i(),origin:l,features:{}};f[s]?(f[s]("DOMContentLoaded",o,!1),u[s]("load",t,!1)):(f[p]("onreadystatechange",r),u[p]("onload",t)),a("mark",["firstbyte",i()])},{1:12,2:3,handle:"D5DuLP"}],loader:[function(n,e){e.exports=n("G9z0Bl")},{}],12:[function(n,e){function t(n,e){var t=[],o="",i=0;for(o in n)r.call(n,o)&&(t[i]=e(o,n[o]),i+=1);return t}var r=Object.prototype.hasOwnProperty;e.exports=t},{}],13:[function(n,e){function t(n,e,t){e||(e=0),"undefined"==typeof t&&(t=n?n.length:0);for(var r=-1,o=t-e||0,i=Array(0>o?0:o);++r<o;)i[r]=n[e+r];return i}e.exports=t},{}]},{},["G9z0Bl"]);</script>
<title>Computer Science 155 - Lab 15</title>
<style>
body { font-family:Arial, Helvetica, sans-serif;
color:#036;
line-height: 125%;
}
h1 {text-align:center;
}
strong { font-family:Consolas, "Courier New", monospace;
color:#03F;
}
li { margin-bottom: 15px; }
pre { font-family:"Courier New", Courier, monospace;
color:gray;
}
td { padding: 3px; font-family: Consolas, "Courier new", monospace; color: #339;
}
.style1 { font-family: Consolas, "Courier New", monospace;
          font-weight:bold;
  }

.rightcol { color: darkgreen;
          }
.strong {  color: darkgreen;
          font-family:"Courier New", Courier, monospace;
       }
ol.upper-roman {list-style-type: upper-alpha;}
.data  { color: blue;   }

</style>
<script type="text/javascript" src="./assign15_files/MathML.js"></script><script type="text/javascript">D2LMathML.DesktopInit('/d2l/common/mathjax/2.1/MathJax.js?config=MML_HTMLorMML&v=10.3.0.791-39','/d2l/common/mathjax/2.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML&v=10.3.0.791-39');</script><script type="text/x-mathjax-config;executed=true">MathJax.Hub.Config({ delayStartupUntil: "onload",showProcessingMessages: false, messageStyle: "none", showMathMenu: true, showMathMenuMSIE: true, menuSettings: { context: "MathJax", zoom: "None" },NativeMML: { showMathMenuMSIE: false, scale: 140 }, "HTML-CSS": { linebreaks: { automatic: true, width: "container"}, imageFont: null, scale: 130 } });</script><script type="text/javascript" src="./assign15_files/MathJax.js"></script><style type="text/css">.MathJax_Hover_Frame {border-radius: .25em; -webkit-border-radius: .25em; -moz-border-radius: .25em; -khtml-border-radius: .25em; box-shadow: 0px 0px 15px #83A; -webkit-box-shadow: 0px 0px 15px #83A; -moz-box-shadow: 0px 0px 15px #83A; -khtml-box-shadow: 0px 0px 15px #83A; border: 1px solid #A6D ! important; display: inline-block; position: absolute}
.MathJax_Hover_Arrow {position: absolute; width: 15px; height: 11px; cursor: pointer}
</style><style type="text/css">#MathJax_About {position: fixed; left: 50%; width: auto; text-align: center; border: 3px outset; padding: 1em 2em; background-color: #DDDDDD; color: black; cursor: default; font-family: message-box; font-size: 120%; font-style: normal; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 15px; -webkit-border-radius: 15px; -moz-border-radius: 15px; -khtml-border-radius: 15px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_Menu {position: absolute; background-color: white; color: black; width: auto; padding: 5px 0px; border: 1px solid #CCCCCC; margin: 0; cursor: default; font: menu; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 5px; -webkit-border-radius: 5px; -moz-border-radius: 5px; -khtml-border-radius: 5px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_MenuItem {padding: 1px 2em; background: transparent}
.MathJax_MenuTitle {background-color: #CCCCCC; margin: -5px 0 0 0; text-align: center; font-style: italic; font-size: 80%; color: #444444; padding: 2px 0; overflow: hidden}
.MathJax_MenuArrow {position: absolute; right: .5em; color: #666666}
.MathJax_MenuActive .MathJax_MenuArrow {color: white}
.MathJax_MenuCheck {position: absolute; left: .7em}
.MathJax_MenuRadioCheck {position: absolute; left: .7em}
.MathJax_MenuLabel {padding: 1px 2em 3px 1.33em; font-style: italic}
.MathJax_MenuRule {border-top: 1px solid #DDDDDD; margin: 4px 3px}
.MathJax_MenuDisabled {color: GrayText}
.MathJax_MenuActive {background-color: #606872; color: white}
.MathJax_Menu_Close {position: absolute; width: 31px; height: 31px; top: -15px; left: -15px}
</style><style type="text/css">#MathJax_Zoom {position: absolute; background-color: #F0F0F0; overflow: auto; display: block; z-index: 301; padding: .5em; border: 1px solid black; margin: 0; font-weight: normal; font-style: normal; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; box-shadow: 5px 5px 15px #AAAAAA; -webkit-box-shadow: 5px 5px 15px #AAAAAA; -moz-box-shadow: 5px 5px 15px #AAAAAA; -khtml-box-shadow: 5px 5px 15px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_ZoomOverlay {position: absolute; left: 0; top: 0; z-index: 300; display: inline-block; width: 100%; height: 100%; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
#MathJax_ZoomEventTrap {position: absolute; left: 0; top: 0; z-index: 302; display: inline-block; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
</style><style type="text/css">.MathJax_Preview {color: #888}
#MathJax_Message {position: fixed; left: 1em; bottom: 1.5em; background-color: #E6E6E6; border: 1px solid #959595; margin: 0px; padding: 2px 8px; z-index: 102; color: black; font-size: 80%; width: auto; white-space: nowrap}
#MathJax_MSIE_Frame {position: absolute; top: 0; left: 0; width: 0px; z-index: 101; border: 0px; margin: 0px; padding: 0px}
.MathJax_Error {color: #CC0000; font-style: italic}
</style></head>

<body><div id="MathJax_Message" style="display: none;"></div>
<h1>Lab 15</h1>
<h1>Triggers</h1>
<h2>Due</h2>
<p>At the start of your next <b>scheduled</b> lab at the same day and time. In other words:</p>
<blockquote>
<p>Lab section 1A: due Thursday, March 12th @ 1:00pm<br> Lab section 1B: due Thursday, March 12th @ 11:30pm<br> Lab section 2A: due Thursday, March 12th @ 8:30am<br> Lab section 2B: due Wednesday, March 11th @ 12:30pm</p>
</blockquote>
<p>[Note: Lab 13 is due]</p>
<h2>Prerequisites</h2>
<p>Read Chapter 11, pages 369-374.</p>
<p>Read the lecture notes on triggers.</p>
<h2>Objective</h2>
<ul>
<li>Program triggers</li>
</ul>
<h2>Do</h2>
<ul>
<li>Try the examples given in your text. Use the <a href="create_tables.sql" target="_blank">available script to create</a> the tables you will need. This <a href="drop_tables.sql" target="_blank">script will drop</a> the tables when you are done.</li>
<li>Read the section on triggers in the Oracle documentation. There are two parts to read:<ol>
<li><a href="http://docs.oracle.com/database/121/LNPLS/triggers.htm#LNPLS020" target="_blank">A general overview of triggers</a></li>
<li><a href="https://docs.oracle.com/cd/B19306_01/server.102/b14220/triggers.htm" target="_blank">Details on trigger creation syntax</a></li>
<li><a href="http://docs.oracle.com/cd/E11882_01/appdev.112/e25519/triggers.htm#LNPLS750" target="_blank">Oracle hints for this lab</a></li>
</ol></li>
</ul>
<h2>Assignment</h2>
<ul>
<li>Before beginning the assignment, make sure you have a clean copy of your HR (Human Resources) database tables. You can recreate the HR tables in your schema by:
<ul>
<li>First running a script called <strong>hr_drop.sql</strong>. This script will drop all your HR tables so that they can be recreated.</li>
<li>Then run <strong>hr_Start.sql</strong>. This script will recreate all the tables and load the data.</li>
<li>You should have both of these scripts your H: drive from Lab 1. If you don't have these scripts, you can <a href="HumanResourceScripts.ZIP">get them again here</a>.</li>
</ul>
</li>
<li>As the programmer in charge of payroll, you are responsible for ensuring that all payroll restrictions are implemented via database triggers. The Vice President is concerned that the table (the <strong>employees</strong> table) holding the salaries is experiencing a lot of activity. You've been tasked to write a <strong>trigger&nbsp;</strong>to audit the activity on this table.
<p>Part 1. Updating an audit table using triggers.</p>
<ul>
<li>Use the <a href="create_audit.sql">provided script</a> to create an audit table.</li>
<li>Create a row-level database trigger called <strong>audit_salary</strong> on the <strong>employees&nbsp;</strong>table to do the following:<ol>
<li>After deleting a record in the <strong>employees</strong> table, add a row to the audit table which gives the user name (use the system <strong>USER</strong>), the table name '<strong>Employees</strong>' (just give the name as a string), the current date, and puts an '<strong>X</strong>' in the <strong>del</strong> column of the audit table.</li>
<li>After inserting a record, add a row to the audit table which gives the user name, the table name '<strong>Employees</strong>' (just give the name as a string), the current date, and puts an '<strong>X</strong>' in the <strong>ins</strong> column of the audit table.</li>
<li>After updating a record, add a row to the audit table which gives the user name, the table name '<strong>Employees</strong>' (just give the name as a string), the current date, and puts an '<strong>X</strong>' in the <strong>upd</strong> column of the audit table.</li>
<li>After updating the <strong>salary</strong> column of the <strong>employees</strong> table, add a row to the audit table which gives the user name, the table name '<strong>Employees</strong>' (just give the name as a string), the column name '<strong>Salary</strong>' (just given the name as a string), the current date, and puts an '<strong>X</strong>' in the <strong>upd</strong> column of the audit table. (Note: There is no need to add a second general update record. If the <strong>salary</strong> column is being updated, that is the only update record that needs to be added to the <strong>audit_table</strong>.)</li>
</ol></li>
<li>Be sure to test your trigger and save it on your H: drive.</li>
</ul>
</li>
<li>The Vice President is further concerned that hackers are getting into the <strong>employees</strong> table and changing their salaries to a larger amount. He wants you to track all transactions on the <strong>employees&nbsp;</strong>table in which the salary is updated.
<p>Part 2. Updating a transaction table using triggers.</p>
<ul>
<li>Use the <a href="create_trans.sql" target="_blank">provided script</a> to create a transaction table.</li>
<li>Modify your trigger from Part 1 to also post a copy of the employee id, first name, last name, <b>old</b> salary, <b>new</b> salary, and the current date to the transaction table after updating the <strong>salary</strong> column of the <strong>employees</strong> table.</li>
<li>Save your modified trigger on your H: drive.</li>
</ul>
</li>
<li>Prepare a script to test all aspects (both Part 1 and Part 2) of your trigger. In other words, you should test that when you delete a row, the appropriate record is written to the <strong>audit_table</strong> and so on. You can demonstrate both parts in your one script. Once you have your test script prepared and running correctly, run the script as a demonstration for your instructor to check.</li>
<li>You can use the command
<blockquote><strong>SHOW ERRORS</strong></blockquote>
to get more information on any PL/SQL error you might get when you create your trigger.</li>
</ul>
<h2>Hand-In</h2>
<h3>1. Demonstration:</h3>
<p>For the demonstration of all aspect of your trigger, make sure you start with a clean copy of the HR database and empty audit and transaction tables. Be prepared to demonstrate the following:</p>
<ol>
<li>The contents of your <i>audit_table</i> table, showing it has no rows.</li>
<li>The contents of your <i>transaction_salary_table</i> table, showing it has no rows.</li>
<li>A record deleted from the <strong>employees</strong> table</li>
<li>A record inserted into the <strong>employees</strong> table.</li>
<li>A general update (NOT salary) of a record in the <strong>employees</strong> table.</li>
<li>An update of a salary in the employees table.</li>
<li>The contents of your <i>audit_table</i> table, showing the results of the above.</li>
<li>The contents of your <i>transaction_salary_table</i>, showing the results of the above.</li>
</ol>
<h3>2. Hand-In</h3>
<p>Print out a copy of the code of your tested trigger from Part 2 <b>OR</b> submit the trigger code to your D2L Dropbox.</p>
<h2>Remember</h2>
<ul>
<li>To save your trigger on your H: drive</li>
<li>To drop and purge your audit and transaction tables.</li>
</ul>
<h2>Hints</h2>
<ul>
<li>For Exercise 1, your trigger should handle all the conditions in a single trigger. In other words you will have something like the following to start:
<pre>CREATE OR REPLACE TRIGGER audit_salary
AFTER DELETE OR INSERT OR UPDATE ON employees
</pre>
etc.</li>
<li>You can test for various conditions within your trigger using the <strong>IF</strong>, <strong>ELSIF</strong>, <strong>ELSE</strong> structure. For example: <br>
<pre>  IF DELETING THEN
     INSERT INTO audit_table 
     etc.
  ELSIF INSERTING THEN
     INSERT INTO audit_table 
     etc.
 </pre>
</li>
<li>For the user name you are inserting into the audit_table, just use "user". For example:
<pre>     INSERT INTO audit_table 
     (user_name, etc.
     VALUES
     (user, etc.
    </pre>
</li>
</ul>

<script src="./assign15_files/nr-536.min.js"></script></body></html>
